<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="0x01 老生常谈&amp;emsp;&amp;emsp;众所周知，多线程的合理使用可以提高CPU利用率，在实际开发中最常见的就是涉及大量计算以及网络请求的时候，都会新开一个线程，避免主线程被阻塞让用户觉得app卡顿。但凡事都不能过犹不及，滥用多线程也会给性能造成影响，毕竟线程之间的切换也是需要花费开销的。 &amp;emsp;&amp;emsp;既然叫多线程，那么线程之间肯定是有优先级区别的，在iOS中，有这么几种权限：123">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈iOS多线程_使用篇">
<meta property="og:url" content="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/index.html">
<meta property="og:site_name" content="朝暮的闲暇时刻">
<meta property="og:description" content="0x01 老生常谈&amp;emsp;&amp;emsp;众所周知，多线程的合理使用可以提高CPU利用率，在实际开发中最常见的就是涉及大量计算以及网络请求的时候，都会新开一个线程，避免主线程被阻塞让用户觉得app卡顿。但凡事都不能过犹不及，滥用多线程也会给性能造成影响，毕竟线程之间的切换也是需要花费开销的。 &amp;emsp;&amp;emsp;既然叫多线程，那么线程之间肯定是有优先级区别的，在iOS中，有这么几种权限：123">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/thread_label.png">
<meta property="og:image" content="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/dipatch_once.png">
<meta property="og:updated_time" content="2018-02-09T09:38:57.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="浅谈iOS多线程_使用篇">
<meta name="twitter:description" content="0x01 老生常谈&amp;emsp;&amp;emsp;众所周知，多线程的合理使用可以提高CPU利用率，在实际开发中最常见的就是涉及大量计算以及网络请求的时候，都会新开一个线程，避免主线程被阻塞让用户觉得app卡顿。但凡事都不能过犹不及，滥用多线程也会给性能造成影响，毕竟线程之间的切换也是需要花费开销的。 &amp;emsp;&amp;emsp;既然叫多线程，那么线程之间肯定是有优先级区别的，在iOS中，有这么几种权限：123">
<meta name="twitter:image" content="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/thread_label.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/"/>





  <title>浅谈iOS多线程_使用篇 | 朝暮的闲暇时刻</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">朝暮的闲暇时刻</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://leylfl.github.io/2018/01/16/浅谈iOS多线程-使用篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="朝暮">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="朝暮的闲暇时刻">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">浅谈iOS多线程_使用篇</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-16T14:21:25+08:00">
                2018-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="0x01-老生常谈"><a href="#0x01-老生常谈" class="headerlink" title="0x01 老生常谈"></a>0x01 老生常谈</h1><p>&emsp;&emsp;众所周知，多线程的合理使用可以提高CPU利用率，在实际开发中最常见的就是涉及大量计算以及网络请求的时候，都会新开一个线程，避免主线程被阻塞让用户觉得app卡顿。但凡事都不能过犹不及，滥用多线程也会给性能造成影响，毕竟线程之间的切换也是需要花费开销的。</p>
<p>&emsp;&emsp;既然叫多线程，那么线程之间肯定是有优先级区别的，在iOS中，有这么几种权限：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSInteger</span>, <span class="built_in">NSQualityOfService</span>) &#123;</span><br><span class="line">    <span class="comment">// 用户交互权限，属于最高等级，常被用于处理交互事件或者刷新UI，因为这些需要即时的</span></span><br><span class="line">    <span class="built_in">NSQualityOfServiceUserInteractive</span> = <span class="number">0x21</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 为了可以进一步的后续操作，当用户发起请求结果需要被立即展示，比如当点了列表页某条信息后需要立即加载详情信息</span></span><br><span class="line">    <span class="built_in">NSQualityOfServiceUserInitiated</span> = <span class="number">0x19</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不需要马上就能得到结果，比如下载任务。当资源被限制后，此权限的任务将运行在节能模式下以提供更多资源给更高的优先级任务</span></span><br><span class="line">    <span class="built_in">NSQualityOfServiceUtility</span> = <span class="number">0x11</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 后台权限，通常用户都不能意识到有任务正在进行，比如数据备份等。大多数处于节能模式下，需要把资源让出来给更高的优先级任务</span></span><br><span class="line">    <span class="built_in">NSQualityOfServiceBackground</span> = <span class="number">0x09</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认权限，具体权限由系统根据实际情况来决定使用哪个等级权限，如果实际情况不太利于决定使用何种权限，则从UserInitiated和Utility之间选一个权限并使用。</span></span><br><span class="line">    <span class="built_in">NSQualityOfServiceDefault</span> = <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="0x02-使用多线程"><a href="#0x02-使用多线程" class="headerlink" title="0x02 使用多线程"></a>0x02 使用多线程</h1><p>&emsp;&emsp;在iOS中，实现多线程常用的有三种方式：NSThread、GCD和NSOperation；以及一个不怎么常用的pthread。</p>
<h3 id="1-NSThread"><a href="#1-NSThread" class="headerlink" title="1. NSThread"></a>1. NSThread</h3><h4 id="1-1-如何使用"><a href="#1-1-如何使用" class="headerlink" title="1.1 如何使用"></a>1.1 如何使用</h4><p>&emsp;&emsp;加上iOS10新增的，现在有5种初始化方法，具体初始化代码这边就不放了，实例方法中非block初始化的需要调用start方法进行线程开启：</p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)detachNewThreadWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block; <span class="comment">// iOS 10 新增</span></span><br><span class="line">+ (<span class="keyword">void</span>)detachNewThreadSelector:(SEL)selector toTarget:(<span class="keyword">id</span>)target withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)argument;</span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block; <span class="comment">// iOS 10 新增</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTarget:(<span class="keyword">id</span>)target selector:(SEL)selector object:(<span class="keyword">nullable</span> <span class="keyword">id</span>)argument;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;苹果更是为了程序员更方便的调用，直接在NSObject写了扩展，我们只要[self perform….]这样的调用，就能轻松开启一个线程。</p>
<p>&emsp;&emsp;在iOS 8开始，苹果给NSThread提供了<strong>qualityOfService</strong>属性来设置优先级，比如：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">NSThread</span> detachNewThreadWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"线程1开始执行。。。"</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">NSThread</span> detachNewThreadSelector:<span class="keyword">@selector</span>(thread2Selector:) toTarget:<span class="keyword">self</span> withObject:<span class="string">@"test"</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSThread</span> *thread3 = [[<span class="built_in">NSThread</span> alloc] initWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"线程3开始执行。。。"</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSThread</span> *thread4 = [[<span class="built_in">NSThread</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(thread4Selector:) object:<span class="string">@"test"</span>];</span><br><span class="line">    thread4.qualityOfService = <span class="built_in">NSQualityOfServiceUserInteractive</span>;</span><br><span class="line">    </span><br><span class="line">    [thread3 start];</span><br><span class="line">    [thread4 start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)thread2Selector:(<span class="keyword">id</span>)info &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"线程2开始执行。。。"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)thread4Selector:(<span class="keyword">id</span>)info &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"线程4开始执行。。。"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;运行结果很清楚的看到，我设置了最高等级的线程4优先执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-01-02 16:05:09.599964+0800 HotPatch[54134:37810941] 线程4开始执行。。。</span><br><span class="line">2018-01-02 16:05:09.601452+0800 HotPatch[54134:37810939] 线程2开始执行。。。</span><br><span class="line">2018-01-02 16:05:09.602699+0800 HotPatch[54134:37810938] 线程1开始执行。。。</span><br><span class="line">2018-01-02 16:05:09.602698+0800 HotPatch[54134:37810940] 线程3开始执行。。。</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;其他属性这里不做着重说明，API都有的，也都很好理解。</p>
<h4 id="1-2-总结"><a href="#1-2-总结" class="headerlink" title="1.2 总结"></a>1.2 总结</h4><p>&emsp;&emsp;我们可以看到，NSThread适用于业务场景不是很复杂的时候，属于比较轻量级的，同时在NSThread进行了相关拓展，所以开发中调用也极其方便。同时缺点也很明显，不能设置线程之间的依赖关系，需要手动管理睡眠唤醒等。</p>
<hr>
<h3 id="2-Grand-Central-Dispatch-GCD"><a href="#2-Grand-Central-Dispatch-GCD" class="headerlink" title="2. Grand Central Dispatch (GCD)"></a>2. Grand Central Dispatch (GCD)</h3><p>&emsp;&emsp;GCD是C实现的，所以效率相对更高，可以更好更方便的让并行代码执行在多核设备上，而且GCD是系统级的，帮助程序可以更合理的利用可用资源。跟NSThread相比，在使用GCD时我们并不需要手动管理任务，我们只需要把任务塞到队列里，系统的线程池会自动帮我们运行和销毁等。在ARC下，GCD的内存管理跟其他对象一样，在非ARC下，需要通过dispatch_retain和dispatch_release进行管理。<br>&emsp;&emsp;详细说GCD之前，我们先说说下面几个概念：并行、串行、同步和异步。  </p>
<ul>
<li>串行：任务是一个一个有顺序的执行，一个执行完以后才执行下一个。(有序的)  </li>
<li>并行：跟串行相反，任务是无序的执行，执行顺序没有顺序关系。（无序的）   </li>
<li>同步：需要等上一个任务执行完成后才能执行下一个任务。（依赖于上个任务是否执行完毕）  </li>
<li>异步：不需要等到上一个任务执行完成才执行下一个任务。（无需依赖于上个任务是否执行完毕）  </li>
</ul>
<p>&emsp;&emsp;在GCD里，我们通过<strong>DISPATCH_QUEUE_SERIAL</strong>和<strong>DISPATCH_QUEUE_CONCURRENT</strong>分别表示串行和并行；通过<strong>dispatch_sync</strong>和<strong>dispatch_async</strong>分别表示同步和异步。它们之间互相结合会碰撞出什么样的火花？我们下面通过代码看下结果：  </p>
<p>① 串行同步<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先是串行同步的情况。</span></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serailQueue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;根据运行结果，串行同步的任务是<strong>在主线程上</strong>一个一个有顺序的完成的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-01-03 09:22:59.451187+0800 HotPatch[84240:38942350] 在主线程上，第一只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:22:59.451341+0800 HotPatch[84240:38942350] 在主线程上，第二只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:22:59.451450+0800 HotPatch[84240:38942350] 在主线程上，第三只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;接着，我们观察下串行异步的结果会是如何？  </p>
<p>② 串行异步<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> serailQueue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(serailQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;根据结果，我们可以看到，串行异步的情况下，新开辟了一条线程，该线程上的执行任务的顺序是有序的，而主线程上的任务是与该线程是并行执行的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-01-03 09:24:04.200707+0800 HotPatch[84293:38945063] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br><span class="line">2018-01-03 09:24:04.200707+0800 HotPatch[84293:38945539] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:24:04.200874+0800 HotPatch[84293:38945539] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:24:04.200969+0800 HotPatch[84293:38945539] 非主线程上，第三只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>③ 并行同步<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;根据结果来看，虽然是在并行队列上，但是并没有新开线程，都是在主线程上按顺序来执行任务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-01-03 09:30:56.633674+0800 HotPatch[84466:38953980] 在主线程上，第一只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:30:56.633827+0800 HotPatch[84466:38953980] 在主线程上，第二只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:30:56.633913+0800 HotPatch[84466:38953980] 在主线程上，第三只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:30:56.633992+0800 HotPatch[84466:38953980] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>④ 并行异步<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> concurrentQueue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(concurrentQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;根据结果来看，并行异步下，会开启多个线程执行任务，他们之间的顺序包括主线程是无序的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2018-01-03 09:36:48.246392+0800 HotPatch[84632:38962053] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:36:48.246392+0800 HotPatch[84632:38962045] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line">2018-01-03 09:36:48.246392+0800 HotPatch[84632:38961995] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br><span class="line">2018-01-03 09:36:48.246392+0800 HotPatch[84632:38962046] 非主线程上，第三只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;前面我们已经说过，串行异步，会新开一个线程，该线程里的任务按顺序执行，那么，我新建了多个串行队列，那么他们之间的关系是怎么样的？是不是也是按照顺序排排坐吃果果呢？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue1, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue3 = dispatch_queue_create(<span class="string">"com.zhaomu.test3"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue3, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(serialQueue3, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第四只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;根据下面的运行结果可以看到开了多个串行队列的情况下，多个串行队列之间可能是并行执行的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-01-03 10:09:58.754283+0800 HotPatch[85801:39008283] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br><span class="line">2018-01-03 10:09:58.754287+0800 HotPatch[85801:39008328] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line">2018-01-03 10:09:58.754287+0800 HotPatch[85801:39008330] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line">2018-01-03 10:09:58.754287+0800 HotPatch[85801:39008329] 非主线程上，第三只熊猫向你走过来...</span><br><span class="line">2018-01-03 10:09:58.754514+0800 HotPatch[85801:39008329] 非主线程上，第四只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;至此，他们四者之间的关系大致搞清楚了，那么这里遗留一个问题，下面的代码会有什么问题？为什么会导致这样的问题？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> serialQueue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(serialQueue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-创建队列"><a href="#2-1-创建队列" class="headerlink" title="2.1 创建队列"></a>2.1 创建队列</h4><p>&emsp;&emsp;之前在了解串行、并行、同步和异步的时候，已经看到可以通过dispatch_queue_create创建一个队列。那么还有其他方法吗？相信大家已经很快想到了:<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;对于这两个方法，也没有什么特别要讲的，相信大家在实际开发中也已经用了很多很多了。只是提一点，dispatch_get_global_queue得到的队列， dispatch_suspend，dispatch_resume和dispatch_set_context函数对其是无效的，具体的后面再详细说明。<br>&emsp;&emsp;回到dispatch_queue_create方法，之前只是说了可以设置参数来控制返回的是串行还是并行队列，但是如果我想对这个队列进行优先级设置，我们该怎么做呢？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_USER_INTERACTIVE, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;dispatch_queue_attr_make_with_qos_class函数可以设置队列优先级，它的第二个参数设置优先级。这里的优先级有这几个选择，也有其对应的宏定义。具体解释可以对应本文开头的优先级解释：</p>
<ul>
<li><strong>QOS_CLASS_USER_INTERACTIVE</strong> （DISPATCH_QUEUE_PRIORITY_HIGH）</li>
<li><strong>QOS_CLASS_USER_INITIATED</strong> （DISPATCH_QUEUE_PRIORITY_HIGH）</li>
<li><strong>QOS_CLASS_UTILITY</strong> （DISPATCH_QUEUE_PRIORITY_LOW）</li>
<li><strong>QOS_CLASS_DEFAULT</strong> （DISPATCH_QUEUE_PRIORITY_DEFAULT）</li>
<li><strong>QOS_CLASS_BACKGROUND</strong> （DISPATCH_QUEUE_PRIORITY_BACKGROUND）   </li>
</ul>
<p>&emsp;&emsp;dispatch_queue_attr_make_with_qos_class函数的第三个参数，需要填写一个<strong>负数</strong>的偏移值，小于0且大于等于-15(QOS_MIN_RELATIVE_PRIORITY即表示为-15)，必须这么填，不然函数会返回一个null。这个参数主要作用是在你给定的优先级系统不能满足的情况下，如果需要调度的话，给定一个调度偏移值。</p>
<p>&emsp;&emsp;当然，我们还可以通过<strong>dispatch_set_target_queue</strong>给目标队列设置优先级，比如设置权限前，我们的代码是这样的：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_get_global_queue(<span class="built_in">NSQualityOfServiceUserInitiated</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_get_global_queue(<span class="built_in">NSQualityOfServiceUserInteractive</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">55.094364</span>+<span class="number">0800</span> HotPatch[<span class="number">87483</span>:<span class="number">39063303</span>] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">10</span>:<span class="number">51</span>:<span class="number">55.094374</span>+<span class="number">0800</span> HotPatch[<span class="number">87483</span>:<span class="number">39063315</span>] 非主线程上，第一只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;将第二个队列权限设置为第一个队列一样：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_get_global_queue(<span class="built_in">NSQualityOfServiceUserInitiated</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_get_global_queue(<span class="built_in">NSQualityOfServiceUserInteractive</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_set_target_queue(queue2, queue1);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">10</span>:<span class="number">54</span>:<span class="number">54.485234</span>+<span class="number">0800</span> HotPatch[<span class="number">87580</span>:<span class="number">39067563</span>] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">10</span>:<span class="number">54</span>:<span class="number">54.485234</span>+<span class="number">0800</span> HotPatch[<span class="number">87580</span>:<span class="number">39067564</span>] 非主线程上，第二只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>dispatch_set_target_queue</strong>除了可以设置优先级，同样可以设置队列类型，比如如下面的代码，其结果因为可以多开线程，所以其运行顺序是无序的：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">07.245436</span>+<span class="number">0800</span> HotPatch[<span class="number">87849</span>:<span class="number">39079716</span>] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">07.245431</span>+<span class="number">0800</span> HotPatch[<span class="number">87849</span>:<span class="number">39079659</span>] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">07.245436</span>+<span class="number">0800</span> HotPatch[<span class="number">87849</span>:<span class="number">39079717</span>] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">03</span>:<span class="number">07.245436</span>+<span class="number">0800</span> HotPatch[<span class="number">87849</span>:<span class="number">39079714</span>] 非主线程上，第三只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;现在我的需求是，队列1执行完后，我再去执行队列2，可以修改如下：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">dispatch_set_target_queue(queue2, queue1);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第一只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第二只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，第三只熊猫向你走过来..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@主线程上，熊猫妈妈在找熊猫宝宝..."</span>, [<span class="built_in">NSThread</span> isMainThread] ? <span class="string">@"在"</span> : <span class="string">@"非"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">16.703801</span>+<span class="number">0800</span> HotPatch[<span class="number">88657</span>:<span class="number">39110595</span>] 在主线程上，熊猫妈妈在找熊猫宝宝...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">16.703801</span>+<span class="number">0800</span> HotPatch[<span class="number">88657</span>:<span class="number">39110643</span>] 非主线程上，第一只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">16.703987</span>+<span class="number">0800</span> HotPatch[<span class="number">88657</span>:<span class="number">39110643</span>] 非主线程上，第二只熊猫向你走过来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">16.704185</span>+<span class="number">0800</span> HotPatch[<span class="number">88657</span>:<span class="number">39110643</span>] 非主线程上，第三只熊猫向你走过来...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要注意的是，这里dispatch_set_target_queue设置时机是设置block任务之前，同时不能循环设置，比如上面把queue1设置给了queue2，如果在queue2设置给queue1，这样会导致问题。</p>
<h4 id="2-2-设置队列标识"><a href="#2-2-设置队列标识" class="headerlink" title="2.2 设置队列标识"></a>2.2 设置队列标识</h4><p>&emsp;&emsp;通过dispatch_queue_set_specific可以设置队列标识，然后通过dispatch_get_specific来帮助我们判断是否在某个队列中。其中参数key是个标识符，用来绑定所对应队列的上下文环境，举个例子：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> *key = <span class="string">"key"</span>;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    dispatch_queue_set_specific(queue1, key, &amp;key, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSelector) withObject:<span class="literal">nil</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue2, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSelector2) withObject:<span class="literal">nil</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector &#123;</span><br><span class="line">    <span class="keyword">if</span>(dispatch_get_specific(key)) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"这个key所属的队列是queue1队列"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"这个key所属的队列不是queue1队列"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector2 &#123;</span><br><span class="line">    <span class="keyword">if</span>(dispatch_get_specific(key)) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"这个key所属的队列是queue2队列"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"这个key所属的队列不是queue2队列"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打印结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">16.396954</span>+<span class="number">0800</span> HotPatch[<span class="number">92482</span>:<span class="number">39270353</span>] 这个key所属的队列不是queue2队列</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-03</span> <span class="number">14</span>:<span class="number">02</span>:<span class="number">16.396960</span>+<span class="number">0800</span> HotPatch[<span class="number">92482</span>:<span class="number">39270355</span>] 这个key所属的队列是queue1队列</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;看了api可能会有疑问，dispatch_queue_get_specific和dispatch_get_specific，有什么区别？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> * dispatch_queue_get_specific(<span class="built_in">dispatch_queue_t</span> queue, <span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br><span class="line"><span class="keyword">void</span> * dispatch_get_specific(<span class="keyword">const</span> <span class="keyword">void</span> *key);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;前者比后者多传了一个队列参数，所以显而易见，前者判断的是所传队列的上下文数据是不是绑定为标识符为key的；而后者则是判断当前所在上下文环境是不是标识符为key的。<br>&emsp;&emsp;细心的朋友可能会问，既然是标识符，那api里还有个dispatch_queue_get_label是干嘛用的？我们之前调用dispatch_queue_create函数的时候，第一个参数就是label。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_SERIAL);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;这个label，可以在debug的时候，用于显示当前线程所在队列的名称，如下图：<img src="thread_label.png" alt="线程label示例"><br>&emsp;&emsp;那么label还有什么用处？相信肯定有的人唰唰唰写出如下代码，当然这也不是说不可以:<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue1, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSelector) withObject:<span class="literal">nil</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *labelName = [<span class="built_in">NSString</span> stringWithUTF8String:dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL)];</span><br><span class="line">    <span class="keyword">if</span> ([labelName isEqualToString:<span class="string">@"com.zhaomu.test1"</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"现在所处queue1队列"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;那么问题又来了，如何判断当前是否是主线程，相信很快有人会回答[NSThread isMainThread]！！！那么，我们知道一个主线程可以有多个队列，那么如何判断是否在主队列呢？<br>&emsp;&emsp;这里介绍两种方法：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一种方法</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> mainQueue = dispatch_get_main_queue();</span><br><span class="line">    dispatch_queue_set_specific(mainQueue, key, &amp;key, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(mainQueue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSelector) withObject:<span class="literal">nil</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector &#123;</span><br><span class="line">    <span class="keyword">if</span>(dispatch_get_specific(key)) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"注意，这里是主线程主队列！！！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种方法</span></span><br><span class="line">    <span class="built_in">NSString</span> *currentLabel = [<span class="built_in">NSString</span> stringWithUTF8String:dispatch_queue_get_label(DISPATCH_CURRENT_QUEUE_LABEL)];</span><br><span class="line">    <span class="built_in">NSString</span> *mainLabel = [<span class="built_in">NSString</span> stringWithUTF8String:dispatch_queue_get_label(dispatch_get_main_queue())];</span><br><span class="line">    <span class="keyword">if</span>([currentLabel isEqualToString:mainLabel]) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"注意，这里是主线程主队列！！！"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-3-dispatch-after"><a href="#2-3-dispatch-after" class="headerlink" title="2.3 dispatch_after"></a>2.3 dispatch_after</h4><p>&emsp;&emsp;这个函数，大家肯定不陌生，用的也肯定滚瓜烂熟。这个函数的作用就是倒计时的时间到了后，将block任务添加到指定的队列里面去，然后执行。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    <span class="comment">// 1秒后去做的事情</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;复习时间到了，那么我给出如下代码，dispatch_after里面的代码会在1秒后执行吗？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"本次操作需要2秒，操作完成"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_sync</span>(queue, ^&#123;</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"本次操作需要5秒，操作完成"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1</span> * <span class="built_in">NSEC_PER_SEC</span>)), queue, ^&#123;</span><br><span class="line">    <span class="comment">// 1秒后去做的事情</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"1秒后能来到这吗"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;答案是并不会，我们前面说过，并行同步是排排坐吃果果的，是按顺序执行任务的，dispatch_after一秒后的确把任务提交到队列了，但是因为前面的任务还没有完成，所以它也就只能乖乖等着了。<br>&emsp;&emsp;谈到延时执行，肯定大家还会想到另一个方法：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)performSelector:(SEL)aSelector withObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)anArgument afterDelay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;那么这个方法跟dispatch_after又有什么区别呢？观察下面的代码，我的疑问就是熊猫宝宝会向您奔来吗，也就是会不会执行testSelector方法？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>), ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(testSelector) withObject:<span class="literal">nil</span> afterDelay:<span class="number">2</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"一只熊猫宝宝向您奔来...."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;答案是否定的，方法并没有执行。这是为什么呢？performSelector:afterDelay方法内部其实有个NSTimer定时器，需要把定时器加到runloop进行执行，所以这个方法需要依赖runloop，那么我们必须知道的是，开启的子线程默认是没有runloop的，所以导致testSelector方法没有被执行。而dispatch_after并没有这个问题。<br>&emsp;&emsp;拓展一下，GCD中除了dispatch_after，还有一种类似于NSTimer的计时器，也就是通过dispatch_source来设置定时器。其实如果看源码dispatch_after内部也是通过dispatch_source进行实现的。这里只是先做介绍，后面到dispatch_source章节再详细说明。</p>
<h4 id="2-4-dispatch-once"><a href="#2-4-dispatch-once" class="headerlink" title="2.4 dispatch_once"></a>2.4 dispatch_once</h4><p>&emsp;&emsp;这个函数常用于构造一份唯一的实例，用于app内存域中达到资源共享。所以有时候我们看到一个项目里会有很多单例。那么，我们是否思考过，真的有必要在app里使用很多的单例，那么如果使用不当会造成什么后果？<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> once];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)once &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> once];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"遇到一只熊猫宝宝..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> once];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)once &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> otherOnce];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"遇到第一只熊猫宝宝..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)otherOnce &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> once];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"遇到第二只熊猫宝宝..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们看下栈的追踪，可以发现死锁了，具体原因在下篇GCD源码篇具体说明。<img src="dipatch_once.png" alt="dipatch_once示例"><br>&emsp;&emsp;除了单例这种方式，是否还有别的方式能达到资源共享？在Xcode 8开始，支持了类属性：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span>(<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>, <span class="keyword">class</span>) <span class="built_in">NSString</span> *name;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;所以，我们可以利用这个新的特性，来完成资源共享。</p>
<h4 id="2-5-dispatch-block"><a href="#2-5-dispatch-block" class="headerlink" title="2.5 dispatch_block"></a>2.5 dispatch_block</h4><p>&emsp;&emsp;dipatch_block，可以理解为一个block对象，拿到这个对象可以让我们独立操作一个任务，我们可以更灵活的操作一个任务，比如等待、执行以及监听任务的完成，以便在这个任务完成后去做些什么。<br>&emsp;&emsp;一般来说，我们可以这样定义一个GCD的block对象。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">dispatch_block_t block = ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"一只熊脑宝宝向你奔来..."</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, block);</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5-1-dispatch-block-create"><a href="#2-5-1-dispatch-block-create" class="headerlink" title="2.5.1 dispatch_block_create"></a>2.5.1 dispatch_block_create</h5><p>&emsp;&emsp;当然，一般开发场景下并不需要这么啰嗦的实现方式，没必要把block单独拿出来。而且需要注意的是，上面的声明方式，这个block是在栈上的。我们还有一种初始化block对象的方式，但是说这个之前，我们先了解下面枚举值的意思：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> : <span class="keyword">unsigned</span> <span class="keyword">long</span> &#123;</span><br><span class="line">    <span class="comment">// 当提交到DISPATCH_QUEUE_CONCURRENT队列，类似于dispatch_barrier_async（后面会介绍）作用。如果标记为这个的block对象被直接调用，将没有barrier效果。</span></span><br><span class="line">    DISPATCH_BLOCK_BARRIER,</span><br><span class="line">    <span class="comment">// block对象将解除与当前执行上下文属性的关联，如果直接调用，在分配给block属性之前，在调用线程上block对象将在block任务执行期间移出这些属性。如果提交到队列，block对象将使用队列属性或者分配给Block对象的属性。</span></span><br><span class="line">    DISPATCH_BLOCK_DETACHED,</span><br><span class="line">    <span class="comment">// Block对象被创建的同时会为block对象分配执行上下文属性。如果直接调用，block对象将在block任务执行期间将这些属性应用于调用线程。如果block任务被提交到队列，则这个标识将在提交队列的同时会替换其所关联的block对象默认的上下文属性。</span></span><br><span class="line">    DISPATCH_BLOCK_ASSIGN_CURRENT,</span><br><span class="line">    <span class="comment">// 表示不能设置优先级属性给block，如果block被直接调用，将会使用当前线程的优先级。如果被提交到队列，在提交到队列的同时将会取消原来的优先级属性。在dispatch_block_create_with_qos_class函数中，这个属性无效。</span></span><br><span class="line">    DISPATCH_BLOCK_NO_QOS_CLASS,</span><br><span class="line">    <span class="comment">// block和队列同时有优先级属性的情况下，优先使用队列的优先级。当队列没有优先级属性的情况下，block的优先级才会被采用，当block被执行调用，这个属性无效；如果被提交到并行异步队列，这个属性是默认的。</span></span><br><span class="line">    DISPATCH_BLOCK_INHERIT_QOS_CLASS。</span><br><span class="line">    <span class="comment">// block的优先级属性要高于队列的优先级属性。如果block被直接调用或被提交到并行同步队列，这个属性是默认的</span></span><br><span class="line">    DISPATCH_BLOCK_ENFORCE_QOS_CLASS</span><br><span class="line">&#125; dispatch_block_flags_t;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;dispatch_block_create也可以创建一个block对象，并且重点是分配在堆上的，在创建 的时候，可以设置一个标识位，就是上面说的那几个。<br>&emsp;&emsp;创建出来的block提交到队列的时候同时会为block赋值一个默认的优先级属性，但也有例外，这三个标识位就不会默认设置优先级，分别是DISPATCH_BLOCK_ASSIGN_CURRENT、DISPATCH_BLOCK_NO_QOS_CLASS和DISPATCH_BLOCK_DETACHED。<br>&emsp;&emsp;当Block队列放入并行同步队列，DISPATCH_BLOCK_ENFORCE_QOS_CLASS 是默认的。当被放入并行异步队列，DISPATCH_BLOCK_INHERIT_QOS_CLASS是默认的。如果一个被赋值了优先级属性的block对象被放入到一个串行队列，那么系统将会尽可能的让已经在前面的block对象与这个block对象拥有一个优先级或者更高优先级，以让之前的block任务优先执行。<br>&emsp;&emsp;前面说到可以给block设置优先级，所以先介绍下dispatch_block_create_with_qos_class函数，跟之前dispatch_block_create相比，多了一个dispatch_qos_class_t属性，用来设置优先级，以及relative_priority属性，表示偏移值，这个参数主要作用是在你给定的优先级系统不能满足的情况下，如果需要调度的话，给定一个调度偏移值。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">    dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_ENFORCE_QOS_CLASS, QOS_CLASS_USER_INTERACTIVE, <span class="number">-1</span>, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue1, block1);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue2, block2);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue2, block3);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从运行结果来看，我们使用了DISPATCH_BLOCK_INHERIT_QOS_CLASS标记位，使得block的优先级高于队列的优先级，所以block2始终优先执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-01-06 21:00:46.583204+0800 HotPatch[4917:43250223] 第二只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-06 21:00:46.583230+0800 HotPatch[4917:43250226] 第一只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-06 21:00:46.583239+0800 HotPatch[4917:43250225] 第三只熊猫宝宝向你奔来...</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5-2-dispatch-block-perform"><a href="#2-5-2-dispatch-block-perform" class="headerlink" title="2.5.2 dispatch_block_perform"></a>2.5.2 dispatch_block_perform</h5><p>&emsp;&emsp;直接执行block，使用这个函数，对block设置优先级是无效的。当然也直接比如block()这样执行block，效果是一样的：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create_with_qos_class(DISPATCH_BLOCK_DETACHED, QOS_CLASS_USER_INTERACTIVE, <span class="number">-1</span>, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_perform(DISPATCH_BLOCK_DETACHED, block1);</span><br><span class="line">    block2();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-06</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">24.000871</span>+<span class="number">0800</span> HotPatch[<span class="number">5329</span>:<span class="number">43266428</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-06</span> <span class="number">21</span>:<span class="number">15</span>:<span class="number">24.001041</span>+<span class="number">0800</span> HotPatch[<span class="number">5329</span>:<span class="number">43266428</span>] 第二只熊猫宝宝向你奔来...</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5-2-dispatch-block-wait"><a href="#2-5-2-dispatch-block-wait" class="headerlink" title="2.5.2 dispatch_block_wait"></a>2.5.2 dispatch_block_wait</h5><p>&emsp;&emsp;这个函数的作用是等待block任务完成，再继续往下执行代码。需要注意的是，这个函数的使用是要在立即执行命令之后，或者加入到队列之后。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, block1);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block2);</span><br><span class="line"></span><br><span class="line">dispatch_block_wait(block2, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block3);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;看到运行结果，直到block2的任务完成，下面的命令才会被继续执行。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-01-07 09:30:37.900512+0800 HotPatch[7042:43373020] 第二只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 09:30:37.900488+0800 HotPatch[7042:43373010] 第一只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 09:30:42.971854+0800 HotPatch[7042:43373020] 第二只熊猫宝宝已经抱住你大腿...</span><br><span class="line">2018-01-07 09:30:42.972097+0800 HotPatch[7042:43372948] 熊猫妈妈在找熊猫宝宝...</span><br><span class="line">2018-01-07 09:30:42.972101+0800 HotPatch[7042:43373010] 第三只熊猫宝宝向你奔来...</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5-3-dispatch-block-notify"><a href="#2-5-3-dispatch-block-notify" class="headerlink" title="2.5.3 dispatch_block_notify"></a>2.5.3 dispatch_block_notify</h5><p>&emsp;&emsp;这个函数起到通知的作用，也就是当这个函数监听的任务完成后，会执行dispatch_block_notify函数自己的任务。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, block1);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block2);</span><br><span class="line"></span><br><span class="line">dispatch_block_notify(block2, queue2, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"捕获一个熊猫宝宝..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block3);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;我们可以看到，dispatch_block_notify的block任务会在block2任务完成后被调用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-01-07 09:35:17.368299+0800 HotPatch[7252:43379370] 熊猫妈妈在找熊猫宝宝...</span><br><span class="line">2018-01-07 09:35:17.368419+0800 HotPatch[7252:43379414] 第一只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 09:35:17.368538+0800 HotPatch[7252:43379416] 第二只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 09:35:17.368558+0800 HotPatch[7252:43379423] 第三只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 09:35:22.369035+0800 HotPatch[7252:43379416] 第二只熊猫宝宝已经抱住你大腿...</span><br><span class="line">2018-01-07 09:35:22.369436+0800 HotPatch[7252:43379416] 捕获一个熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;那么，dispatch_block_notify函数的block任务是不是一定是在监听的任务完成后马上调用呢，事实是并不一定的，如果dispatch_block_notify函数的的block任务所在线程前面还有任务没有被执行完毕，那么这个block任务需要等待前面任务的完成，也就没有及时性了。我们举个例子，在串行队列中，就会很明显感到这个：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">    dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">8</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block4 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue1, block1);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue2, block2);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue2, block3);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_notify(block2, queue2, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"捕获一个熊猫宝宝..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue2, block4);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">29.295842</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">29.295967</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">32.297043</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第二只熊猫宝宝已经抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">32.297180</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40.298124</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第三只熊猫宝宝已经抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40.298385</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 第四只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40.298400</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393272</span>] 捕获一个熊猫宝宝...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40.298521</span>+<span class="number">0800</span> HotPatch[<span class="number">7413</span>:<span class="number">43393215</span>] 熊猫妈妈在找熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如果一个block任务被多个监听，那么这几个dispatch_block_notify函数的回调并不是有序的，也就是说并不是写在前面，这个回调最先执行，而是看所在队列，如果谁先被轮到执行就是谁优先。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">    dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue1, block1);</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue2, block2);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_notify(block2, queue2, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"捕获一个熊猫宝宝1..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_notify(block2, queue1, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"捕获一个熊猫宝宝2..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_sync</span>(queue2, block3);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">01.608315</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410127</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">01.608485</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410127</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">04.608668</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410127</span>] 第二只熊猫宝宝已经抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">04.608838</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410127</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">04.608862</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410172</span>] 捕获一个熊猫宝宝<span class="number">2.</span>..</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">04.608866</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410182</span>] 捕获一个熊猫宝宝<span class="number">1.</span>..</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-07</span> <span class="number">10</span>:<span class="number">01</span>:<span class="number">04.608929</span>+<span class="number">0800</span> HotPatch[<span class="number">7755</span>:<span class="number">43410127</span>] 熊猫妈妈在找熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<h5 id="2-5-4-dispatch-block-cancel"><a href="#2-5-4-dispatch-block-cancel" class="headerlink" title="2.5.4 dispatch_block_cancel"></a>2.5.4 dispatch_block_cancel</h5><p>&emsp;&emsp;这个函数的作用就是取消block任务，但是前提就是这个block还没有被执行。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue1 = dispatch_queue_create(<span class="string">"com.zhaomu.test1"</span>, attr_t);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue2 = dispatch_queue_create(<span class="string">"com.zhaomu.test2"</span>, attr_t);</span><br><span class="line">dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝已经抱住你大腿..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">     <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue1, block1);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block2);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue2, block3);</span><br><span class="line"></span><br><span class="line">dispatch_block_cancel(block3);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;运行结果可以看到，block3是没有被执行的，已经被取消了，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2018-01-07 18:46:13.991672+0800 HotPatch[8198:43441461] 第一只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 18:46:13.991672+0800 HotPatch[8198:43441459] 第二只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-07 18:46:17.063260+0800 HotPatch[8198:43441459] 第二只熊猫宝宝已经抱住你大腿...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要注意的是内存问题，如果这个Block是做内存释放的操作，如果block被取消了，会造成内存问题。</p>
<h5 id="2-5-6-dispatch-block-suspend、dispatch-block-resume"><a href="#2-5-6-dispatch-block-suspend、dispatch-block-resume" class="headerlink" title="2.5.6 dispatch_block_suspend、dispatch_block_resume"></a>2.5.6 dispatch_block_suspend、dispatch_block_resume</h5><p>&emsp;&emsp;只适用于自定义的队列，不适用于dispatch_get_global_queue等。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block1 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block2 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_block_t block3 = dispatch_block_create(DISPATCH_BLOCK_DETACHED, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_suspend(queue);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, block1);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, block2);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, block3);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈正在找熊猫宝宝...."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    dispatch_resume(queue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">35.628261</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56902962</span>] 熊猫妈妈正在找熊猫宝宝....</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">38.629397</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903020</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">38.629410</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903012</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">38.629412</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903019</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">43.629721</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903020</span>] 第一只熊猫宝宝抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">43.629721</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903019</span>] 第三只熊猫宝宝抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">11</span>:<span class="number">26</span>:<span class="number">43.629721</span>+<span class="number">0800</span> HotPatch[<span class="number">95183</span>:<span class="number">56903012</span>] 第二只熊猫宝宝抱住你的大腿...</span><br></pre></td></tr></table></figure></p>
<h4 id="2-6-dispatch-group"><a href="#2-6-dispatch-group" class="headerlink" title="2.6 dispatch_group"></a>2.6 dispatch_group</h4><p>&emsp;&emsp;在实际开发中，我们经常会遇到一种情况，就是需要调用多个接口，然后等接口都请求完毕后，我们再去处理一些事情，比如UI更新等。那么这种情况，可以有多种实现方法，其中之一就是这里要介绍的 – dispatch_group。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_notify(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"捕获所有熊猫宝宝..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">22.261748</span>+<span class="number">0800</span> HotPatch[<span class="number">12918</span>:<span class="number">43636778</span>] 第一只熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">22.261746</span>+<span class="number">0800</span> HotPatch[<span class="number">12918</span>:<span class="number">43636779</span>] 第二只熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">25.334679</span>+<span class="number">0800</span> HotPatch[<span class="number">12918</span>:<span class="number">43636779</span>] 第二只熊猫抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">25.334679</span>+<span class="number">0800</span> HotPatch[<span class="number">12918</span>:<span class="number">43636778</span>] 第一只熊猫抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">08</span>:<span class="number">55</span>:<span class="number">25.334900</span>+<span class="number">0800</span> HotPatch[<span class="number">12918</span>:<span class="number">43636779</span>] 捕获所有熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;dispatch_group_notify并不是阻塞线程的，如果想要任务没有完成不必继续往下执行，我们可以使用到dispatch_group_wait函数，起到阻塞线程的作用，当然建议是如果情非得已，不是很推荐使用这样的方式。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫抱住你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"捕获所有熊猫宝宝..."</span>);</span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">09</span>:<span class="number">18</span>:<span class="number">28.990738</span>+<span class="number">0800</span> HotPatch[<span class="number">13852</span>:<span class="number">43662410</span>] 第一只熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">09</span>:<span class="number">18</span>:<span class="number">28.990723</span>+<span class="number">0800</span> HotPatch[<span class="number">13852</span>:<span class="number">43662408</span>] 第二只熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">09</span>:<span class="number">18</span>:<span class="number">32.062137</span>+<span class="number">0800</span> HotPatch[<span class="number">13852</span>:<span class="number">43662410</span>] 第一只熊猫抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">09</span>:<span class="number">18</span>:<span class="number">32.062137</span>+<span class="number">0800</span> HotPatch[<span class="number">13852</span>:<span class="number">43662408</span>] 第二只熊猫抱住你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-08</span> <span class="number">09</span>:<span class="number">18</span>:<span class="number">32.062398</span>+<span class="number">0800</span> HotPatch[<span class="number">13852</span>:<span class="number">43662317</span>] 捕获所有熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;想必，可能很多人有这样的疑问，项目中，大多数后台接口的调用的方式是这样的：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> [[RequestManager shareInstance] getxxxxSuccess:^&#123;</span><br><span class="line">        </span><br><span class="line">&#125; failure:^&#123;</span><br><span class="line">        </span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;那么，如何把这样的任务，也加入到dispatch_group_t中呢？这时候需要用到这么一对函数：dispatch_group_enter和dispatch_group_leave。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line">dispatch_group_t group = dispatch_group_create();</span><br><span class="line"></span><br><span class="line">[[RequestManager shareInstance] getxxxxSuccess:^&#123;</span><br><span class="line">    dispatch_group_enter(group);</span><br><span class="line">&#125; failure:^&#123;</span><br><span class="line">    dispatch_group_leave(group);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"接口请求完毕..."</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;当然，除了dispatch_group可以达到我们的需求，那有没有其他方法也可以实现这个功能呢？</p>
<h4 id="2-7-dispatch-semaphore"><a href="#2-7-dispatch-semaphore" class="headerlink" title="2.7 dispatch_semaphore"></a>2.7 dispatch_semaphore</h4><p>&emsp;&emsp;dispatch_semaphore的作用除了可以加锁还可以保持线程同步。首先了解两个函数，dispatch_semaphore_signal表示信号量+1,dispatch_semaphore_wait表示如果信号量为0则进行等待，如果不为1，则继续往下执行并-1。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line"></span><br><span class="line">dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面的代码展示了线程同步的问题，当所有任务完成后才继续执行下面的指令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-01-09 09:05:18.659970+0800 HotPatch[2324:47129676] 第一只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-09 09:05:18.659970+0800 HotPatch[2324:47129675] 第二只熊猫宝宝向你奔来...</span><br><span class="line">2018-01-09 09:05:21.660470+0800 HotPatch[2324:47129676] 第一只熊猫宝宝抱住你大腿...</span><br><span class="line">2018-01-09 09:05:21.660708+0800 HotPatch[2324:47129675] 第二只熊猫宝宝抱住你大腿...</span><br><span class="line">2018-01-09 09:05:21.660749+0800 HotPatch[2324:47129513] 熊猫妈妈在找熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;但是一般的建议，除非万不得已，最好不要在主线程调用dispatch_semaphore_wait，毕竟阻塞主线程的事能不做还是不要做的。可以放到异步线程里进行等待：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"你等在原地等待被抱大腿..."</span>);</span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"你的大腿已经被熊猫宝宝抱住..."</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;当然，也可以控制任务一个接着一个执行。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈在找熊猫宝宝..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">13.467029</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871112</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">16.467211</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871112</span>] 第一只熊猫宝宝抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">16.467420</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871109</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">19.467450</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871109</span>] 第三只熊猫宝宝抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">19.467641</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871110</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">22.467738</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871110</span>] 第二只熊猫宝宝抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-09</span> <span class="number">17</span>:<span class="number">33</span>:<span class="number">22.467997</span>+<span class="number">0800</span> HotPatch[<span class="number">96939</span>:<span class="number">83871111</span>] 熊猫妈妈在找熊猫宝宝...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;dispatch_semaphore_wait跟dispatch_semaphore_signal必须匹配的。如果写出dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);这样的代码，而没有dispatch_semaphore_signal与之匹配，就会陷入无限等待。比如在同一个一个线程中，先调用了dispatch_semaphore_wait函数，如下示例：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误</span></span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    </span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">    dispatch_semaphore_signal(semaphore);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确</span></span><br><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        </span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住你大腿..."</span>);</span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>
<h4 id="2-8-dispatch-barrier"><a href="#2-8-dispatch-barrier" class="headerlink" title="2.8 dispatch_barrier"></a>2.8 dispatch_barrier</h4><h4 id="2-8-1-dispatch-barrier-async"><a href="#2-8-1-dispatch-barrier-async" class="headerlink" title="2.8.1 dispatch_barrier_async"></a>2.8.1 dispatch_barrier_async</h4><p>&emsp;&emsp;dispatch_barrier_async会等待前面的任务执行完毕后，阻塞后面的任务，当自己的任务执行完毕后才会继续执行后面的block任务。需要注意的是，使用这个函数的前提是你使用了自己创建的队列，如果使用dispatch_get_global_queue或者自定义的队列是串行队列则等同于dispatch_async。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">18.239814</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702026</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">18.239828</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">23.306770</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702026</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">23.306783</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">23.307009</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">28.377030</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">28.377252</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第四只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">08</span>:<span class="number">33.451332</span>+<span class="number">0800</span> HotPatch[<span class="number">91915</span>:<span class="number">56702034</span>] 第四只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;看下，如果使用的不是自定义队列的效果：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);<span class="comment">//dispatch_queue_create("com.zhaomu.test", attr_t);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈找熊猫宝宝...."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">19.930798</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719799</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">19.930798</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719798</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">19.930798</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719706</span>] 熊猫妈妈找熊猫宝宝....</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">19.930807</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719797</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">19.930819</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719811</span>] 第四只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">24.930909</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719799</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">24.930910</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719811</span>] 第四只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">24.930910</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719797</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">14</span>:<span class="number">24.930909</span>+<span class="number">0800</span> HotPatch[<span class="number">92146</span>:<span class="number">56719798</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure></p>
<h4 id="2-8-2-dispatch-barrier-sync"><a href="#2-8-2-dispatch-barrier-sync" class="headerlink" title="2.8.2 dispatch_barrier_sync"></a>2.8.2 dispatch_barrier_sync</h4><p>&emsp;&emsp;这个函数可以起到阻塞线程的作用，同样的，前提是必须使用自定义的并行队列，串行队列也不可以，不然等同于dispatch_sync。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_attr_t attr_t = dispatch_queue_attr_make_with_qos_class(DISPATCH_QUEUE_CONCURRENT,  QOS_CLASS_UTILITY, QOS_MIN_RELATIVE_PRIORITY);</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, attr_t);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_barrier_sync(queue, ^&#123;</span><br><span class="line">         <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈找熊猫宝宝...."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果，可以看到主线程也被阻塞了</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">16</span>:<span class="number">55.716809</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726566</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">16</span>:<span class="number">55.716792</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726568</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">00.784030</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726568</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">00.784030</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726566</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">00.784281</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726517</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">05.785264</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726517</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">05.785450</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726517</span>] 熊猫妈妈找熊猫宝宝....</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">05.785495</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726569</span>] 第四只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">09</span>:<span class="number">17</span>:<span class="number">10.850254</span>+<span class="number">0800</span> HotPatch[<span class="number">92335</span>:<span class="number">56726569</span>] 第四只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure></p>
<h4 id="2-9-dispatch-source"><a href="#2-9-dispatch-source" class="headerlink" title="2.9 dispatch_source"></a>2.9 dispatch_source</h4><p>&emsp;&emsp;通过dispatch_source_create创建一个对象。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_t dispatch_source_create(dispatch_source_type_t type, uintptr_t handle, <span class="keyword">unsigned</span> <span class="keyword">long</span> mask, <span class="built_in">dispatch_queue_t</span> queue);</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;第一个参数是一个dispatch_source类型，提供的类型如下：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DISPATCH_SOURCE_TYPE_DATA_ADD</span><br><span class="line">DISPATCH_SOURCE_TYPE_DATA_OR</span><br><span class="line">DISPATCH_SOURCE_TYPE_MACH_RECV</span><br><span class="line">DISPATCH_SOURCE_TYPE_MACH_SEND</span><br><span class="line">DISPATCH_SOURCE_TYPE_PROC</span><br><span class="line">DISPATCH_SOURCE_TYPE_READ</span><br><span class="line">DISPATCH_SOURCE_TYPE_SIGNAL</span><br><span class="line">DISPATCH_SOURCE_TYPE_TIMER</span><br><span class="line">DISPATCH_SOURCE_TYPE_VNODE</span><br><span class="line">DISPATCH_SOURCE_TYPE_WRITE</span><br><span class="line">DISPATCH_SOURCE_TYPE_MEMORYPRESSURE</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;例子之前讲过一个定时器，在dispatch_source中，可能算是比较常用的一种。其他具体使用场景，暂未接触到，如果有更好的场景，后面再加进来。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_queue_create(<span class="string">"com.zhaomu.test"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">self</span>.source = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, <span class="number">0</span>, <span class="number">0</span>, queue);</span><br><span class="line">    dispatch_source_set_timer(<span class="keyword">self</span>.source, dispatch_walltime(<span class="literal">NULL</span>, <span class="number">0</span>), <span class="number">5</span>ull * <span class="built_in">NSEC_PER_SEC</span>, <span class="number">0</span>);</span><br><span class="line">    dispatch_source_set_event_handler(<span class="keyword">self</span>.source, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span> testSelector];</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_source_set_cancel_handler(<span class="keyword">self</span>.source, ^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@""</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_resume(<span class="keyword">self</span>.source);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)testSelector &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"一只熊猫宝宝向您奔来...."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-NSOperation"><a href="#3-NSOperation" class="headerlink" title="3. NSOperation"></a>3. NSOperation</h3><p>&emsp;&emsp;创建NSOpertioan对象，一般通过NSInvocationOperation和NSBlockOperation来创建。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue.name = <span class="string">@"com.zhaomu.test"</span>;</span><br><span class="line">    <span class="built_in">NSInvocationOperation</span> *op1 = [[<span class="built_in">NSInvocationOperation</span> alloc] initWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(test1) object:<span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加入到队列自动执行任务</span></span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 手动执行任务</span></span><br><span class="line"><span class="comment">//    [op1 start];</span></span><br><span class="line"><span class="comment">//    [op2 start];</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)test1 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">55.292137</span>+<span class="number">0800</span> HotPatch[<span class="number">93798</span>:<span class="number">56833792</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">55.292138</span>+<span class="number">0800</span> HotPatch[<span class="number">93798</span>:<span class="number">56833794</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">00.297201</span>+<span class="number">0800</span> HotPatch[<span class="number">93798</span>:<span class="number">56833792</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">00.297202</span>+<span class="number">0800</span> HotPatch[<span class="number">93798</span>:<span class="number">56833794</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要特别说一下的是一个NSBlockOperation对象可以不断添加任务，其任务之间是并行执行的。<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[op2 addExecutionBlock:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第四只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;当然也是可以设置任务优先级。可以通过queuePriority和qualityOfService设置任务优先级。而且队列之间也可以qualityOfService设置队列的优先级。<br>&emsp;&emsp;那么相比于GCD，NSOperation有哪些优点呢？</p>
<ul>
<li><p>设置最大并发数: maxConcurrentOperationCount  </p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue.name = <span class="string">@"com.zhaomu.test"</span>;</span><br><span class="line">    queue.maxConcurrentOperationCount = <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">    [queue addOperation:op3];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">10.979448</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839976</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">10.979449</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839975</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">15.981534</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839976</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">15.981534</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839975</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">15.981721</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839983</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">31</span>:<span class="number">20.985040</span>+<span class="number">0800</span> HotPatch[<span class="number">93888</span>:<span class="number">56839983</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure>
</li>
<li><p>更方便的设置依赖: addDependency    </p>
<figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue.name = <span class="string">@"com.zhaomu.test"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [op2 addDependency:op1];</span><br><span class="line">    [op3 addDependency:op2];</span><br><span class="line">    </span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">    [queue addOperation:op3];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">33.063585</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842708</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">38.066227</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842708</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">38.066432</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842705</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">43.066665</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842705</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">43.066902</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842705</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">48.071874</span>+<span class="number">0800</span> HotPatch[<span class="number">93949</span>:<span class="number">56842705</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接取消队列内的所有任务: cancelAllOperations  </p>
</li>
<li>阻塞线程等待队列任务全部完成：waitUntilAllOperationsAreFinished </li>
<li>更直观的看到当前队列有多少任务: operationCount <figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">    <span class="built_in">NSOperationQueue</span> *queue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    queue.name = <span class="string">@"com.zhaomu.test"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op1 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第一只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op2 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第二只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSBlockOperation</span> *op3 = [<span class="built_in">NSBlockOperation</span> blockOperationWithBlock:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝向你奔来..."</span>);</span><br><span class="line">        [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"第三只熊猫宝宝抱住了你的大腿..."</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    [queue addOperation:op2];</span><br><span class="line">    [queue addOperation:op3];</span><br><span class="line">    </span><br><span class="line">    [queue waitUntilAllOperationsAreFinished];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"熊猫妈妈正在找熊猫宝宝..."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">02.731265</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860859</span>] 第三只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">02.731265</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860858</span>] 第二只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">02.731265</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860865</span>] 第一只熊猫宝宝向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">07.735805</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860859</span>] 第三只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">07.735805</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860865</span>] 第一只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">07.735813</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860858</span>] 第二只熊猫宝宝抱住了你的大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-01</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">46</span>:<span class="number">07.736033</span>+<span class="number">0800</span> HotPatch[<span class="number">94363</span>:<span class="number">56860808</span>] 熊猫妈妈正在找熊猫宝宝...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="4-pthread"><a href="#4-pthread" class="headerlink" title="4. pthread"></a>4. pthread</h3><p>&emsp;&emsp;pthread更接近底层，这里只做简单的了解即可。代码如下：<br><figure class="highlight obj-c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">    </span><br><span class="line">    pthread_t thread1;</span><br><span class="line">    pthread_t thread2;</span><br><span class="line">    pthread_create(&amp;thread1, <span class="literal">NULL</span>, test, (__bridge <span class="keyword">void</span> *)<span class="string">@"熊猫宝宝跑出来拉"</span>);</span><br><span class="line">    <span class="comment">// 阻塞，等待thread1任务完成</span></span><br><span class="line">    pthread_join(thread1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;thread2, <span class="literal">NULL</span>, test2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">// 线程结束后自动释放资源</span></span><br><span class="line">    pthread_detach(thread1);</span><br><span class="line">    pthread_detach(thread2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *test(<span class="keyword">void</span> *data) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, (__bridge <span class="built_in">NSString</span> *)data);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只小熊猫向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">5</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第一只小熊猫抱住你大腿..."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *test2(<span class="keyword">void</span> *data) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只小熊猫向你奔来..."</span>);</span><br><span class="line">    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"第二只小熊猫抱住你大腿..."</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行结果：</span></span><br><span class="line"><span class="number">2018</span><span class="number">-02</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">20.203050</span>+<span class="number">0800</span> HotPatch[<span class="number">84419</span>:<span class="number">80030841</span>] 熊猫宝宝跑出来拉</span><br><span class="line"><span class="number">2018</span><span class="number">-02</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">20.203215</span>+<span class="number">0800</span> HotPatch[<span class="number">84419</span>:<span class="number">80030841</span>] 第一只小熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-02</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">25.206790</span>+<span class="number">0800</span> HotPatch[<span class="number">84419</span>:<span class="number">80030841</span>] 第一只小熊猫抱住你大腿...</span><br><span class="line"><span class="number">2018</span><span class="number">-02</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">25.207014</span>+<span class="number">0800</span> HotPatch[<span class="number">84419</span>:<span class="number">80030951</span>] 第二只小熊猫向你奔来...</span><br><span class="line"><span class="number">2018</span><span class="number">-02</span><span class="number">-07</span> <span class="number">17</span>:<span class="number">31</span>:<span class="number">28.211189</span>+<span class="number">0800</span> HotPatch[<span class="number">84419</span>:<span class="number">80030951</span>] 第二只小熊猫抱住你大腿...</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如何使用多线程，至此结束，下一篇将要看一看GCD的源码。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/16/浅谈iOS多线程-源码/" rel="prev" title="浅谈iOS多线程(源码)">
                浅谈iOS多线程(源码) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">朝暮</p>
              <p class="site-description motion-element" itemprop="description">联系方式：leylfl@foxmail.com</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#0x01-老生常谈"><span class="nav-number">1.</span> <span class="nav-text">0x01 老生常谈</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#0x02-使用多线程"><span class="nav-number">2.</span> <span class="nav-text">0x02 使用多线程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-NSThread"><span class="nav-number">2.0.1.</span> <span class="nav-text">1. NSThread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-如何使用"><span class="nav-number">2.0.1.1.</span> <span class="nav-text">1.1 如何使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-总结"><span class="nav-number">2.0.1.2.</span> <span class="nav-text">1.2 总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Grand-Central-Dispatch-GCD"><span class="nav-number">2.0.2.</span> <span class="nav-text">2. Grand Central Dispatch (GCD)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-创建队列"><span class="nav-number">2.0.2.1.</span> <span class="nav-text">2.1 创建队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-设置队列标识"><span class="nav-number">2.0.2.2.</span> <span class="nav-text">2.2 设置队列标识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-dispatch-after"><span class="nav-number">2.0.2.3.</span> <span class="nav-text">2.3 dispatch_after</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-4-dispatch-once"><span class="nav-number">2.0.2.4.</span> <span class="nav-text">2.4 dispatch_once</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-5-dispatch-block"><span class="nav-number">2.0.2.5.</span> <span class="nav-text">2.5 dispatch_block</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-1-dispatch-block-create"><span class="nav-number">2.0.2.5.1.</span> <span class="nav-text">2.5.1 dispatch_block_create</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-2-dispatch-block-perform"><span class="nav-number">2.0.2.5.2.</span> <span class="nav-text">2.5.2 dispatch_block_perform</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-2-dispatch-block-wait"><span class="nav-number">2.0.2.5.3.</span> <span class="nav-text">2.5.2 dispatch_block_wait</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-3-dispatch-block-notify"><span class="nav-number">2.0.2.5.4.</span> <span class="nav-text">2.5.3 dispatch_block_notify</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-4-dispatch-block-cancel"><span class="nav-number">2.0.2.5.5.</span> <span class="nav-text">2.5.4 dispatch_block_cancel</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-5-6-dispatch-block-suspend、dispatch-block-resume"><span class="nav-number">2.0.2.5.6.</span> <span class="nav-text">2.5.6 dispatch_block_suspend、dispatch_block_resume</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-6-dispatch-group"><span class="nav-number">2.0.2.6.</span> <span class="nav-text">2.6 dispatch_group</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-dispatch-semaphore"><span class="nav-number">2.0.2.7.</span> <span class="nav-text">2.7 dispatch_semaphore</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-dispatch-barrier"><span class="nav-number">2.0.2.8.</span> <span class="nav-text">2.8 dispatch_barrier</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-1-dispatch-barrier-async"><span class="nav-number">2.0.2.9.</span> <span class="nav-text">2.8.1 dispatch_barrier_async</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-2-dispatch-barrier-sync"><span class="nav-number">2.0.2.10.</span> <span class="nav-text">2.8.2 dispatch_barrier_sync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-9-dispatch-source"><span class="nav-number">2.0.2.11.</span> <span class="nav-text">2.9 dispatch_source</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-NSOperation"><span class="nav-number">2.0.3.</span> <span class="nav-text">3. NSOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-pthread"><span class="nav-number">2.0.4.</span> <span class="nav-text">4. pthread</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朝暮</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
